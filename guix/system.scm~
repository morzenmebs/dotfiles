;; -*- scheme -*-
;; Guix System configuration
;; Reconfigure with: sudo guix system reconfigure ~/dotfiles/guix/system.scm

(use-modules (gnu)
             (gnu system nss)
             (nongnu packages linux)
             (nongnu system linux-initrd))

(use-service-modules desktop networking ssh xorg)
(use-package-modules emacs emacs-xyz freedesktop)

;; EXWM desktop file for display manager session selection
(define exwm-desktop-file
  (plain-file "exwm.desktop"
    "[Desktop Entry]
Name=EXWM
Comment=Emacs X Window Manager
Exec=emacs --fullscreen
TryExec=emacs
Type=Application
DesktopNames=EXWM"))

(operating-system
  (kernel linux)
  (initrd microcode-initrd)
  (firmware (list linux-firmware))

  (host-name "meep")
  (timezone "America/Chicago")  ; adjust to your timezone
  (locale "en_US.utf8")

  (keyboard-layout (keyboard-layout "us"))

  (bootloader
    (bootloader-configuration
      (bootloader grub-bootloader)
      (targets '("/dev/sda"))  ; adjust to your disk
      (keyboard-layout keyboard-layout)))

  (file-systems
    (cons* (file-system
             (mount-point "/")
             (device (file-system-label "guix"))  ; adjust to your label
             (type "ext4"))
           %base-file-systems))

  (users
    (cons* (user-account
             (name "morz")
             (group "users")
             (home-directory "/home/morz")
             (supplementary-groups '("wheel" "netdev" "audio" "video" "input")))
           %base-user-accounts))

  (packages
    (cons* emacs
           emacs-exwm
           emacs-desktop-environment
           %base-packages))

  (services
    (cons*
      ;; Install EXWM session file for GDM
      (simple-service 'exwm-desktop-entry
        xdg-desktop-entries-service-type
        (list exwm-desktop-file))

      (modify-services %desktop-services
        ;; Nonguix substitutes
        (guix-service-type config =>
          (guix-configuration
            (inherit config)
            (substitute-urls
              (cons* "https://substitutes.nonguix.org"
                     %default-substitute-urls))
            (authorized-keys
              (cons* (plain-file "nonguix.pub"
                       "(public-key (ecc (curve Ed25519) (q #C1FD53E5D4CE971933EC50C9F307AE2171A2D3B52C804642A7A35F84F3A4EA98#)))")
                     %default-authorized-guix-keys))))
        
        ;; Configure GDM with EXWM session available
        (gdm-service-type config =>
          (gdm-configuration
            (inherit config)
            (xorg-configuration
              (xorg-configuration
                (keyboard-layout keyboard-layout))))))))

  (name-service-switch %mdns-host-lookup-nss))
